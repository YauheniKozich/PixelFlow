//
//  Basic.h - –†–ï–ù–î–ï–†–ò–ù–ì –ß–ê–°–¢–ò–¶: –ö–∏—Å—Ç—å —Ö—É–¥–æ–∂–Ω–∏–∫–∞ –Ω–∞ GPU
//  ====================================================
//
//  –≠–¢–û–¢ –§–ê–ô–õ - –•–û–õ–°–¢ –ò –ö–†–ê–°–ö–ò!
//  –ó–¥–µ—Å—å —á–∞—Å—Ç–∏—Ü—ã –ø—Ä–µ–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ –ø–∏–∫—Å–µ–ª–∏ –Ω–∞ —ç–∫—Ä–∞–Ω–µ.
//
//  Vertex —à–µ–π–¥–µ—Ä –±–µ—Ä–µ—Ç —á–∞—Å—Ç–∏—Ü—ã –∏–∑ –ø–∞–º—è—Ç–∏ –∏ —Ä–∞–∑–º–µ—â–∞–µ—Ç –∏—Ö –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ.
//  Fragment —à–µ–π–¥–µ—Ä —Ä–∏—Å—É–µ—Ç –∫–∞–∂–¥—É—é —á–∞—Å—Ç–∏—Ü—É —Å –æ—Å–≤–µ—â–µ–Ω–∏–µ–º –∏ —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏.
//
//  –≠—Ç–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —ç—Ç–∞–ø: –æ—Ç –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã—Ö —á–∏—Å–µ–ª –∫ –∫—Ä–∞—Å–∏–≤–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–µ!
//  –ö–∞–∂–¥–∞—è —á–∞—Å—Ç–∏—Ü–∞ –∑–¥–µ—Å—å –æ–∂–∏–≤–∞–µ—Ç —Ü–≤–µ—Ç–æ–º –∏ —Å–≤–µ—Ç–æ–º.
//
//  –ê–≤—Ç–æ—Ä: Yauheni Kozich
//  –°–æ–∑–¥–∞–Ω: 31.10.25
//  –û–±–Ω–æ–≤–ª–µ–Ω: 2025-01-10 - –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–¥—Ä–æ–±–Ω—ã–µ —Ä—É—Å—Å–∫–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
//
//  üìù –û–ü–ò–°–ê–ù–ò–ï: –°–æ–∑–¥–∞–Ω–æ –º–∞–ª–µ–Ω—å–∫–∏–º, –Ω–æ –Ω–µ –≥–ª—É–ø—ã–º –ò–ò –ø–æ–¥ —á—É—Ç–∫–∏–º —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ–º —á–µ–ª–æ–≤–µ–∫–∞
//  ü§ñ –ò–ò: –ü–æ–º–æ–≥–∞–ª —Å —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞–º–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
//  üë®‚Äçüíª –ß–µ–ª–æ–≤–µ–∫: –û–ø—Ä–µ–¥–µ–ª—è–ª —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è
//

#ifndef Basic_h
#define Basic_h

#include <metal_stdlib>
#include "../Core/Utils.h"
#include "../Compute/Simulation.h"
#include "../Effects/Lighting.h"
using namespace metal;

// ============================================================================
// –ö–û–ù–°–¢–ê–ù–¢–´ –†–ï–ù–î–ï–†–ò–ù–ì–ê - –ü–ê–†–ê–ú–ï–¢–†–´ "–•–£–î–û–ñ–ï–°–¢–í–ï–ù–ù–û–ì–û –°–¢–ò–õ–Ø"
// ============================================================================

// –û–°–ù–û–í–ù–´–ï –ü–ê–†–ê–ú–ï–¢–†–´ –ü–†–û–ó–†–ê–ß–ù–û–°–¢–ò
#define PARTICLE_ALPHA_THRESHOLD 0.01   // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
#define PARTICLE_EDGE_SOFTNESS 0.95     // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º—ã—Ç–æ—Å—Ç—å –∫—Ä–∞–µ–≤ –¥–ª—è —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è

// –ö–û–ù–°–¢–ê–ù–¢–´ –≠–õ–ï–ö–¢–†–ò–ß–ï–°–ö–û–ô –ë–£–†–ò - —Å–ø–µ—Ü—ç—Ñ—Ñ–µ–∫—Ç—ã –º–æ–ª–Ω–∏–π
#define STORM_BRIGHTNESS_MULTIPLIER 4.0    // –£—Å–∏–ª–µ–Ω–∏–µ —è—Ä–∫–æ—Å—Ç–∏ –≤ –±—É—Ä–µ
#define STORM_SIZE_MULTIPLIER_MIN 1.5      // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞
#define STORM_SIZE_MULTIPLIER_MAX 2.0      // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞
#define STORM_MAX_BRIGHTNESS 3.0           // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —è—Ä–∫–æ—Å—Ç–∏ (–∑–∞—â–∏—Ç–∞ –æ—Ç –æ—Å–ª–µ–ø–ª–µ–Ω–∏—è)
#define STORM_SPARK_THRESHOLD 0.995        // –ü–æ—Ä–æ–≥ –¥–ª—è –∏—Å–∫—Ä (—Ä–µ–¥–∫–∏–µ –≤—Å–ø—ã—à–∫–∏)
#define STORM_WAVE_SPATIAL_FREQ 15.0       // –ß–∞—Å—Ç–æ—Ç–∞ –≤–æ–ª–Ω —Ç—É—Ä–±—É–ª–µ–Ω—Ç–Ω–æ—Å—Ç–∏
#define STORM_ELECTRIC_UV_SCALE 8.0        // –ú–∞—Å—à—Ç–∞–± —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏—Ö —Ç–µ–∫—Å—Ç—É—Ä
#define STORM_TIME_SCALE_1 3.0             // –°–∫–æ—Ä–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏ 1
#define STORM_TIME_SCALE_2 2.0             // –°–∫–æ—Ä–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏ 2
#define STORM_HUE_SPEED_1 4.0              // –°–∫–æ—Ä–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ 1
#define STORM_HUE_SPEED_2 6.0              // –°–∫–æ—Ä–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ 2

// –ö–û–ù–°–¢–ê–ù–¢–´ –ú–û–õ–ù–ò–ô - zigzag —ç—Ñ—Ñ–µ–∫—Ç—ã
#define LIGHTNING_BOLT_PERIOD 4.0          // –ü–µ—Ä–∏–æ–¥ –º–æ–ª–Ω–∏–π (—Å–µ–∫—É–Ω–¥—ã)
#define LIGHTNING_BOLT_DURATION 0.5        // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º–æ–ª–Ω–∏–∏ (—Å–µ–∫—É–Ω–¥—ã)
#define LIGHTNING_BOLT_WIDTH 0.02          // –¢–æ–ª—â–∏–Ω–∞ –º–æ–ª–Ω–∏–∏ (—Ç–æ–Ω–∫–∞—è)
#define LIGHTNING_BOLT_BRIGHTNESS 5.0      // –Ø—Ä–∫–æ—Å—Ç—å –º–æ–ª–Ω–∏–∏ (–æ—á–µ–Ω—å —è—Ä–∫–∞—è)
#define LIGHTNING_ZIGZAG_FREQ 30.0         // –ß–∞—Å—Ç–æ—Ç–∞ –∑–∏–≥–∑–∞–≥–æ–≤
#define LIGHTNING_ZIGZAG_AMOUNT 0.02       // –ê–º–ø–ª–∏—Ç—É–¥–∞ –∑–∏–≥–∑–∞–≥–æ–≤

// –°–£–ë–ü–ò–ö–°–ï–õ–¨–ù–´–ï –°–ú–ï–©–ï–ù–ò–Ø - –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –Ω–∏–∑–∫–æ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–∏
#define SUBPIXEL_OFFSET_SCALE 0.5          // –ú–∞—Å—à—Ç–∞–± —Å–º–µ—â–µ–Ω–∏—è
#define SUBPIXEL_OFFSET_CENTER 0.25        // –¶–µ–Ω—Ç—Ä —Å–º–µ—â–µ–Ω–∏—è
#define SUBPIXEL_HASH_SEED_1 7.3           // –°–∏–¥ –¥–ª—è X –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
#define SUBPIXEL_HASH_SEED_2 13.7          // –°–∏–¥ –¥–ª—è Y –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã

// –ó–ê–©–ò–¢–ù–´–ï –ö–û–ù–°–¢–ê–ù–¢–´
#define MIN_PARTICLE_SIZE 0.1              // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —á–∞—Å—Ç–∏—Ü—ã

// –†–ï–ñ–ò–ú–´ –ö–ê–ß–ï–°–¢–í–ê –û–°–í–ï–©–ï–ù–ò–Ø
#define LIGHTING_QUALITY_LOW 0             // –¢–æ–ª—å–∫–æ –ø—Ä–æ—Å—Ç–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ
#define LIGHTING_QUALITY_MEDIUM 1          // –°–≤–µ—á–µ–Ω–∏–µ + —ç—Ñ—Ñ–µ–∫—Ç—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π
#define LIGHTING_QUALITY_HIGH 2            // –ü–æ–ª–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ —Å –±–ª—É–º–æ–º

// –ö–û–û–†–î–ò–ù–ê–¢–ù–ê–Ø –°–ò–°–¢–ï–ú–ê
#define NDC_COORDINATE_SYSTEM 1            // –ß–∞—Å—Ç–∏—Ü—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç NDC [-1, 1], –∞ –Ω–µ —ç–∫—Ä–∞–Ω–Ω—ã–µ [0, 1]

// ============================================================================
// VERTEX –®–ï–ô–î–ï–† - –†–ê–ó–ú–ï–©–ï–ù–ò–ï –ß–ê–°–¢–ò–¶ –í –ü–†–û–°–¢–†–ê–ù–°–¢–í–ï
// ============================================================================

/*
    Vertex —à–µ–π–¥–µ—Ä - —ç—Ç–æ –∫–∞–∫ "—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ–ª—å —Ä–æ–ª–µ–π" –≤ —Ç–µ–∞—Ç—Ä–µ.

    –û–Ω –±–µ—Ä–µ—Ç —á–∞—Å—Ç–∏—Ü—ã –∏–∑ –±—É—Ñ–µ—Ä–∞ GPU –∏ —Ä–∞–∑–º–µ—â–∞–µ—Ç –∫–∞–∂–¥—É—é –Ω–∞ —Å—Ü–µ–Ω–µ.
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–∞–∑–º–µ—Ä, –ø–æ–∑–∏—Ü–∏—é, —Ü–≤–µ—Ç - –≤—Å–µ –≤–Ω–µ—à–Ω–∏–µ –∞—Ç—Ä–∏–±—É—Ç—ã.

    –í—Ö–æ–¥: —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ —á–∞—Å—Ç–∏—Ü—ã
    –í—ã—Ö–æ–¥: –≥–æ—Ç–æ–≤–∞—è –∫ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å –ø–æ–∑–∏—Ü–∏–µ–π –∏ —Å–≤–æ–π—Å—Ç–≤–∞–º–∏
*/

struct VertexOut {
    float4 position [[position]];        // –ü–æ–∑–∏—Ü–∏—è –≤ clip space (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)
    float pointSize [[point_size]];      // –†–∞–∑–º–µ—Ä —Ç–æ—á–∫–∏ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
    float4 color;                        // –¶–≤–µ—Ç —á–∞—Å—Ç–∏—Ü—ã
    float brightnessBoost;               // –£—Å–∏–ª–µ–Ω–∏–µ —è—Ä–∫–æ—Å—Ç–∏
    float collectionSpeed;               // –°–∫–æ—Ä–æ—Å—Ç—å —Å–±–æ—Ä–∞ (–¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏)
    float2 screenPos;                    // –ü–æ–∑–∏—Ü–∏—è –Ω–∞ —ç–∫—Ä–∞–Ω–µ (–¥–ª—è –æ—Å–≤–µ—â–µ–Ω–∏—è)
};

/*
    –í–´–ß–ò–°–õ–ï–ù–ò–ï –°–£–ë–ü–ò–ö–°–ï–õ–¨–ù–û–ì–û –°–ú–ï–©–ï–ù–ò–Ø

    –î–ª—è –±–æ—Ä—å–±—ã —Å "–ø–∏–∫—Å–µ–ª—å–Ω—ã–º" –≤–∏–¥–æ–º –ø—Ä–∏ –Ω–∏–∑–∫–æ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–∏.
    –î–æ–±–∞–≤–ª—è–µ—Ç —Å–ª—É—á–∞–π–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –∫ –∫–∞–∂–¥–æ–π —á–∞—Å—Ç–∏—Ü–µ.

    –≠—Ç–æ –∫–∞–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ "—Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏" –∫ –ø–æ–∑–∏—Ü–∏—è–º,
    —á—Ç–æ–±—ã —á–∞—Å—Ç–∏—Ü—ã –Ω–µ –≤—ã–≥–ª—è–¥–µ–ª–∏ –∫–∞–∫ –Ω–∞ —à–∞—Ö–º–∞—Ç–Ω–æ–π –¥–æ—Å–∫–µ.
*/
static inline float2 getSubpixelOffset(uint vid, float2 screenSize, uint pixelSizeMode) {
    // –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω –ø–∏–∫—Å–µ–ª—å-–ø–µ—Ä—Ñ–µ–∫—Ç —Ä–µ–∂–∏–º - –æ—Ç–∫–ª—é—á–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ
    if (pixelSizeMode != 0) {
        return float2(0.0, 0.0);
    }

    // –í—ã—á–∏—Å–ª—è–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–π —á–∞—Å—Ç–∏—Ü—ã
    return float2(
        hash(float(vid) * SUBPIXEL_HASH_SEED_1) * SUBPIXEL_OFFSET_SCALE - SUBPIXEL_OFFSET_CENTER,
        hash(float(vid) * SUBPIXEL_HASH_SEED_2) * SUBPIXEL_OFFSET_SCALE - SUBPIXEL_OFFSET_CENTER
    ) / screenSize * 2.0;  // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤ clip space
}

/*
    –û–°–ù–û–í–ù–û–ô VERTEX –®–ï–ô–î–ï–†

    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–∞–∂–¥—É—é —á–∞—Å—Ç–∏—Ü—É –æ—Ç–¥–µ–ª—å–Ω–æ.
    –ü—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –º–∏—Ä–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —ç–∫—Ä–∞–Ω–Ω—ã–µ.
*/
vertex VertexOut vertexParticle(
    device const Particle* particles [[buffer(0)]],    // –ë—É—Ñ–µ—Ä —á–∞—Å—Ç–∏—Ü
    constant SimulationParams * params [[buffer(1)]],   // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∏–º—É–ª—è—Ü–∏–∏
    uint vid [[vertex_id]]                             // ID –≤–µ—Ä—à–∏–Ω—ã (–Ω–æ–º–µ—Ä —á–∞—Å—Ç–∏—Ü—ã)
) {
    // –ß–∏—Ç–∞–µ–º —á–∞—Å—Ç–∏—Ü—É –∏–∑ –±—É—Ñ–µ—Ä–∞
    Particle p = particles[vid];
   // float2 screenPos = p.position.xy;

    // ============================================================================
    // –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï –ö–û–û–†–î–ò–ù–ê–¢ NDC
    // ============================================================================

    // Particle.position –£–ñ–ï —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö NDC [-1‚Ä¶1].
    // –≠—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ Normalized Device Coordinates –¥–ª—è Metal/GPU.
    float2 ndc = p.position.xy;

    // ============================================================================
    // –ü–û–î–ì–û–¢–û–í–ö–ê –í–´–•–û–î–ù–û–ô –°–¢–†–£–ö–¢–£–†–´ (–ö–û–û–†–î–ò–ù–ê–¢–´ –£–ñ–ï –í CLIP SPACE)
    // ============================================================================

    VertexOut out;

    // –î–æ–±–∞–≤–ª—è–µ–º —Å—É–±–ø–∏–∫—Å–µ–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏ –≤ NDC space
    float2 subpixelOffset = getSubpixelOffset(vid, params[0].screenSize, params[0].pixelSizeMode);
    // ndc —É–∂–µ –≤ clip space [-1, 1], –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –∏ –≤—ã–≤–æ–¥–∏–º
    out.position = float4(ndc + subpixelOffset, 0.0, 1.0);

    // ============================================================================
    // –†–ê–°–ß–ï–¢ –†–ê–ó–ú–ï–†–ê –ß–ê–°–¢–ò–¶–´
    // ============================================================================

    // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã —Ä–∞–∑–º–µ—Ä–∞
    float safeMinSize = max(params[0].minParticleSize, MIN_PARTICLE_SIZE);
    float safeMaxSize = max(params[0].maxParticleSize, safeMinSize);

    // –í —Ä–µ–∂–∏–º–µ –±—É—Ä–∏ —á–∞—Å—Ç–∏—Ü—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –±–æ–ª—å—à–µ –∏ –∑–∞–º–µ—Ç–Ω–µ–µ
    if (params[0].state == SIMULATION_STATE_LIGHTNING_STORM) {
        safeMinSize *= STORM_SIZE_MULTIPLIER_MIN;
        safeMaxSize *= STORM_SIZE_MULTIPLIER_MAX;
    }

    // –†–∞–∑–º–µ—Ä —á–∞—Å—Ç–∏—Ü—ã –í –ü–ò–ö–°–ï–õ–Ø–•.
    // p.size —Ç—Ä–∞–∫—Ç—É–µ—Ç—Å—è –∫–∞–∫ —Ä–∞–∑–º–µ—Ä –æ–¥–Ω–æ–≥–æ –ø–∏–∫—Å–µ–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ –≤—Å–µ—Ö —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–π.
    float pixelSize = max(p.size, safeMinSize);

    // –í —Ä–µ–∂–∏–º–µ –±—É—Ä–∏ —á–∞—Å—Ç–∏—Ü—ã –≤–∏–∑—É–∞–ª—å–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç—Å—è
    if (params[0].state == SIMULATION_STATE_LIGHTNING_STORM) {
        pixelSize *= mix(STORM_SIZE_MULTIPLIER_MIN,
                         STORM_SIZE_MULTIPLIER_MAX,
                         hash(float(vid)));
    }

    // pointSize –≤—Å–µ–≥–¥–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
    out.pointSize = clamp(pixelSize, safeMinSize, safeMaxSize);

    // ============================================================================
    // –ü–û–î–ì–û–¢–û–í–ö–ê –¶–í–ï–¢–ê –ò –ü–ê–†–ê–ú–ï–¢–†–û–í
    // ============================================================================

    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ü–≤–µ—Ç–∞ (–∑–∞—â–∏—Ç–∞ –æ—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö/—Å–ª–∏—à–∫–æ–º —è—Ä–∫–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π)
    out.color = float4(
        clamp(p.color.r, 0.0, 1.0),
        clamp(p.color.g, 0.0, 1.0),
        clamp(p.color.b, 0.0, 1.0),
        clamp(p.color.a, 0.0, 1.0)
    );

    // –ü–µ—Ä–µ–¥–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è fragment —à–µ–π–¥–µ—Ä–∞
    out.brightnessBoost = params[0].brightnessBoost;
    out.collectionSpeed = params[0].collectionSpeed;
    // screenPos –≤ –ø–∏–∫—Å–µ–ª—è—Ö –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Å–≤–µ—â–µ–Ω–∏—è
    // –í–ê–ñ–ù–û: —É—á–∏—Ç—ã–≤–∞–µ–º subpixelOffset, —á—Ç–æ–±—ã –æ—Å–≤–µ—â–µ–Ω–∏–µ —Å–æ–≤–ø–∞–¥–∞–ª–æ —Å –≥–µ–æ–º–µ—Ç—Ä–∏–µ–π
    float2 finalNDC = ndc + subpixelOffset;
    out.screenPos = (finalNDC * 0.5 + 0.5) * params[0].screenSize;

    return out;
}

// ============================================================================
// FRAGMENT –®–ï–ô–î–ï–† - –†–ò–°–û–í–ê–ù–ò–ï –ò –û–°–í–ï–©–ï–ù–ò–ï –ß–ê–°–¢–ò–¶
// ============================================================================

/*
    Fragment —à–µ–π–¥–µ—Ä - —ç—Ç–æ –∫–∞–∫ "–º–∞–ª—è—Ä" –≤ —Ç–µ–∞—Ç—Ä–µ.

    –û–Ω —Ä–∏—Å—É–µ—Ç –∫–∞–∂–¥—É—é —á–∞—Å—Ç–∏—Ü—É –ø–∏–∫—Å–µ–ª—å –∑–∞ –ø–∏–∫—Å–µ–ª–µ–º.
    –î–æ–±–∞–≤–ª—è–µ—Ç —Å–≤–µ—á–µ–Ω–∏–µ, —Ü–≤–µ—Ç–∞, —ç—Ñ—Ñ–µ–∫—Ç—ã - –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç —Ç–æ—á–∫—É –≤ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∏—Å–∫—É—Å—Å—Ç–≤–∞!

    –ö–∞–∂–¥—ã–π –ø–∏–∫—Å–µ–ª—å —á–∞—Å—Ç–∏—Ü—ã –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ —ç—Ç–æ—Ç —à–µ–π–¥–µ—Ä.
*/

/*
    –û–°–ù–û–í–ù–û–ô FRAGMENT –®–ï–ô–î–ï–†

    –†–∏—Å—É–µ—Ç —á–∞—Å—Ç–∏—Ü—É —Å –ø–æ–ª–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –æ—Å–≤–µ—â–µ–Ω–∏—è.
    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞–∑–Ω—ã–µ —Ä–µ–∂–∏–º—ã: –±—É—Ä—è, —Å–±–æ—Ä, –æ–±—ã—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.
*/
fragment float4 fragmentParticle(
    VertexOut in [[stage_in]],                    // –î–∞–Ω–Ω—ã–µ –æ—Ç vertex —à–µ–π–¥–µ—Ä–∞
    float2 pointCoord [[point_coord]],            // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–Ω—É—Ç—Ä–∏ —á–∞—Å—Ç–∏—Ü—ã (0-1)
    constant SimulationParams * params [[buffer(1)]] // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∏–º—É–ª—è—Ü–∏–∏
) {
    // ============================================================================
    // –ü–û–î–ì–û–¢–û–í–ö–ê –ö–û–û–†–î–ò–ù–ê–¢ –ò –§–û–†–ú–´ –ß–ê–°–¢–ò–¶–´
    // ============================================================================

    // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç: (0,0) —Ü–µ–Ω—Ç—Ä ‚Üí (-1,-1) –∫—Ä–∞–π
    float2 uv = pointCoord * 2.0 - 1.0;
    float dist = length(uv);  // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞

    // –°–æ–∑–¥–∞–µ–º –∫—Ä—É–≥–ª—É—é —Ñ–æ—Ä–º—É —Å –º—è–≥–∫–∏–º–∏ –∫—Ä–∞—è–º–∏
    float alpha = 1.0 - smoothstep(1.0 - PARTICLE_EDGE_SOFTNESS, 1.0, dist);

    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –Ω–µ —Ä–∏—Å—É–µ–º –ø–æ—á—Ç–∏ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ –ø–∏–∫—Å–µ–ª–∏
    if (alpha < PARTICLE_ALPHA_THRESHOLD) {
        discard_fragment();  // GPU –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —ç—Ç–æ—Ç –ø–∏–∫—Å–µ–ª—å
    }

    // ============================================================================
    // –í–´–ë–û–† –¶–í–ï–¢–ê –í –ó–ê–í–ò–°–ò–ú–û–°–¢–ò –û–¢ –°–û–°–¢–û–Ø–ù–ò–Ø
    // ============================================================================

    float3 col;  // –§–∏–Ω–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç —á–∞—Å—Ç–∏—Ü—ã

    // –°–ü–ï–¶–ò–ê–õ–¨–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê –≠–õ–ï–ö–¢–†–ò–ß–ï–°–ö–û–ô –ë–£–†–ò ‚ö°
    if (params[0].state == SIMULATION_STATE_LIGHTNING_STORM) {
        // ========================================================================
        // –≠–õ–ï–ö–¢–†–ò–ß–ï–°–ö–ê–Ø –ë–£–†–Ø - –°–ê–ú–´–ô –î–†–ê–ú–ê–¢–ò–ß–ù–´–ô –†–ï–ñ–ò–ú
        // ========================================================================

        // –°–æ–∑–¥–∞–µ–º "—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏–µ" UV –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å –¥–≤–∏–∂–µ–Ω–∏–µ–º
        float2 electricUV = uv * STORM_ELECTRIC_UV_SCALE +
                           float2(params[0].time * STORM_TIME_SCALE_1,
                                 params[0].time * STORM_TIME_SCALE_2);

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–∏–¥ –¥–ª—è –ø—Å–µ–≤–¥–æ-—Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏
        float electricSeed = dot(electricUV, float2(12.9898, 78.233));

        // –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ï –≠–õ–ï–ö–¢–†–ò–ß–ï–°–ö–ò–ï –¶–í–ï–¢–ê - –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –º–µ–Ω—è—é—Ç—Å—è
        float hue1 = hash(electricSeed) * TWO_PI + params[0].time * STORM_HUE_SPEED_1;
        float hue2 = hash(electricSeed + 100.0) * TWO_PI + params[0].time * STORM_HUE_SPEED_2;

        // –ë–∞–∑–æ–≤—ã–π —Ü–≤–µ—Ç: —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏–π –≥–æ–ª—É–±–æ–π/—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π/–±–∏—Ä—é–∑–æ–≤—ã–π
        col = float3(
            0.0 + 0.8 * abs(sin(hue1)),              // –ö—Ä–∞—Å–Ω—ã–π –∫–∞–Ω–∞–ª
            0.2 + 0.6 * abs(sin(hue1 + 1.57)),       // –ó–µ–ª–µ–Ω—ã–π –∫–∞–Ω–∞–ª (—Å–¥–≤–∏–≥ —Ñ–∞–∑—ã)
            0.8 + 0.2 * abs(sin(hue2))               // –°–∏–Ω–∏–π –∫–∞–Ω–∞–ª
        );

        // –î–û–ë–ê–í–õ–Ø–ï–ú –¢–£–†–ë–£–õ–ï–ù–¢–ù–û–°–¢–¨ - –∫–∞–∫ –ø–ª–∞–∑–º–∞
        float turbulence = hash(electricSeed + params[0].time * 2.0) * 0.3;
        col += float3(0.1, 0.2, 0.4) * turbulence;

        // –†–ï–î–ö–ò–ï –Ø–†–ö–ò–ï –ò–°–ö–†–´ - –≤–ø–µ—á–∞—Ç–ª—è—é—â–∏–µ –≤—Å–ø—ã—à–∫–∏
        float sparkSeed = dot(uv * 100.0, float2(1.0, 1.0)) + params[0].time * 10.0;
        if (hash(sparkSeed) > STORM_SPARK_THRESHOLD) {
            col = float3(3.0, 3.0, 3.0);  // –ë–µ–ª—ã–µ –≤—Å–ø—ã—à–∫–∏
        }

        // –≠–ù–ï–†–ì–ï–¢–ò–ß–ï–°–ö–ò–ï –í–û–õ–ù–´ - –º–æ–¥—É–ª—è—Ü–∏—è —è—Ä–∫–æ—Å—Ç–∏
        float waveFreq = 8.0 + hash(electricSeed) * 4.0;
        float wave = sin(params[0].time * waveFreq + length(uv) * STORM_WAVE_SPATIAL_FREQ) * 0.4 + 0.6;
        col *= wave;

        // –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û–ï –£–°–ò–õ–ï–ù–ò–ï –Ø–†–ö–û–°–¢–ò –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –±—É—Ä–∏
        col *= STORM_BRIGHTNESS_MULTIPLIER;

        // ========================================================================
        // –ú–û–õ–ù–ò–ò - ZIGZAG –≠–§–§–ï–ö–¢–´ ‚ö° (SCREEN SPACE, –ö–û–†–†–ï–ö–¢–ù–û)
        // ========================================================================

        float boltTime = fmod(params[0].time * 0.3, LIGHTNING_BOLT_PERIOD);

        if (boltTime < LIGHTNING_BOLT_DURATION) {
            float boltProgress = boltTime / LIGHTNING_BOLT_DURATION;

            // screenPos –≤ –ø–∏–∫—Å–µ–ª—è—Ö ‚Üí –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤ NDC
            float2 pixelNDC = (in.screenPos / params[0].screenSize) * 2.0 - 1.0;

            // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –º–æ–ª–Ω–∏—è –≤ NDC
            float2 boltStart = float2(
                hash(floor(params[0].time) * 7.389) * 2.0 - 1.0,
                1.0
            );

            float2 boltEnd = float2(
                hash(floor(params[0].time) * 13.23) * 2.0 - 1.0,
                -1.0
            );

            float2 boltDir = normalize(boltEnd - boltStart);
            float boltLength = length(boltEnd - boltStart);

            float2 toPixel = pixelNDC - boltStart;
            float alongBolt = dot(toPixel, boltDir);
            float2 closest = boltStart + boltDir * clamp(alongBolt, 0.0, boltLength);
            float acrossBolt = length(pixelNDC - closest);

            float core = exp(-acrossBolt / LIGHTNING_BOLT_WIDTH);

            float zigzag = sin(alongBolt * LIGHTNING_ZIGZAG_FREQ
                               + params[0].time * 20.0)
                           * LIGHTNING_ZIGZAG_AMOUNT;

            float zigzagMask = exp(-abs(zigzag) * 25.0);

            float timeMask = smoothstep(0.0, 0.15, boltProgress) *
                             smoothstep(1.0, 0.7, boltProgress);

            float boltShape = core * zigzagMask * timeMask;

            col += float3(1.0, 1.0, 1.0) * boltShape * LIGHTNING_BOLT_BRIGHTNESS;
        }

    } else {
        // ========================================================================
        // –û–ë–†–ê–ë–û–¢–ö–ê –¶–í–ï–¢–û–í –î–õ–Ø –í–°–ï–• –°–û–°–¢–û–Ø–ù–ò–ô –ö–†–û–ú–ï STORM
        // ========================================================================

        // –ö–†–ò–¢–ò–ß–ù–û: –í —Ä–µ–∂–∏–º–µ CHAOTIC –ø—Ä–æ—Å—Ç–æ –≤—ã–≤–æ–¥–∏–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç —Å —Å–≤–µ—á–µ–Ω–∏–µ–º!
        if (params[0].state == SIMULATION_STATE_CHAOTIC) {
            // –ë–µ—Ä—ë–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç –ë–ï–ó –∫–∞–∫–∏—Ö-–ª–∏–±–æ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–π
            col = in.color.rgb;
            
            // –¢–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª—è–µ–º –º—è–≥–∫–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ
            float glow = pow(1.0 - dist, 2.5) * 0.2;
            col += float3(glow);
        } else {
            // –î–ª—è –¥—Ä—É–≥–∏—Ö —Ä–µ–∂–∏–º–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ
            float localTime = params[0].time * getStateTimeScale(params[0].state);
            col = calculateParticle2DLighting(
                in.color.rgb,           // –ë–∞–∑–æ–≤—ã–π —Ü–≤–µ—Ç —á–∞—Å—Ç–∏—Ü—ã
                in.screenPos,           // –ü–æ–∑–∏—Ü–∏—è –Ω–∞ —ç–∫—Ä–∞–Ω–µ
                dist,                   // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞
                localTime,              // –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
                params[0].state,        // –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                in.brightnessBoost      // –£—Å–∏–ª–µ–Ω–∏–µ —è—Ä–∫–æ—Å—Ç–∏
            );

            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∞–∫—Ü–µ–Ω—Ç—ã –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π
            float stateEnergy = 1.0;
            float rimStrength = 0.0;

            if (params[0].state == SIMULATION_STATE_IDLE) {
                stateEnergy = 0.6;
            }

            if (params[0].state == SIMULATION_STATE_COLLECTING) {
                rimStrength = 0.25;
            }

            if (params[0].state == SIMULATION_STATE_COLLECTED) {
                stateEnergy = 1.0;
                rimStrength = 0.45;
            }

            col *= stateEnergy;

            if (rimStrength > 0.0) {
                float rim = pow(1.0 - dist, 2.0);
                col += float3(1.0, 0.9, 0.7) * rim * rimStrength;
            }
        }
    }

    // ============================================================================
    // –§–ò–ù–ê–õ–¨–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê –ü–†–û–ó–†–ê–ß–ù–û–°–¢–ò
    // ============================================================================

    float finalAlpha;

    switch (params[0].state) {
        case SIMULATION_STATE_LIGHTNING_STORM: {
            // –ë—É—Ä—è: –ø–æ–ª–Ω–∞—è –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Å –∫–æ–Ω—Ç—Ä–æ–ª–µ–º —è—Ä–∫–æ—Å—Ç–∏
            finalAlpha = alpha;
            col = clamp(col, 0.0, STORM_MAX_BRIGHTNESS);
            break;
        }

        case SIMULATION_STATE_COLLECTING:
        case SIMULATION_STATE_COLLECTED: {
            // –†–µ–∂–∏–º—ã —Å–±–æ—Ä–∞: —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏
            finalAlpha = (in.collectionSpeed < 0.0 || in.collectionSpeed > 1000.0)
                ? alpha
                : (alpha * in.color.a);
            break;
        }

        case SIMULATION_STATE_IDLE:
        case SIMULATION_STATE_CHAOTIC:
        default: {
            // –û–±—ã—á–Ω—ã–µ —Ä–µ–∂–∏–º—ã: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–º–µ—à–∏–≤–∞–Ω–∏–µ
            // –£—Å–∏–ª–∏–≤–∞–µ–º –∞–ª—å—Ñ–∞ –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ó–î–ï–°–¨, –≤ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ
            // –≠—Ç–æ –Ω–µ –∏—Å–∫–∞–∂–∞–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ PixelCache, —Ç–æ–ª—å–∫–æ –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            float pixelAlpha = in.color.a;
            
            // –ï—Å–ª–∏ –∞–ª—å—Ñ–∞ –Ω–∏–∑–∫–∞—è/—Å—Ä–µ–¥–Ω—è—è, —É—Å–∏–ª–∏–≤–∞–µ–º –µ—ë –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç–∏
            if (pixelAlpha >= 0.1 && pixelAlpha < 0.8) {
                // –£—Å–∏–ª–∏–≤–∞–µ–º –∞–ª—å—Ñ–∞: –º–∏–Ω–∏–º—É–º 60%, –º–∞–∫—Å–∏–º—É–º 100%
                pixelAlpha = max(0.6, min(pixelAlpha * 2.0, 1.0));
            }
            
            finalAlpha = alpha * pixelAlpha;
            break;
        }
    }

    return float4(col, finalAlpha);
}

// ============================================================================
// –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–´–ô FRAGMENT –®–ï–ô–î–ï–† - –†–ï–ñ–ò–ú –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò
// ============================================================================

/*
    –£–ü–†–û–©–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø –î–õ–Ø –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û–ô –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò

    –ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç—É –≤–µ—Ä—Å–∏—é –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –±—ã—Å—Ç—Ä–æ–¥–µ–π—Å—Ç–≤–∏–µ, –∞ –Ω–µ –∫—Ä–∞—Å–æ—Ç–∞.
    –ó–∞–º–µ–Ω–∏ fragmentParticle –Ω–∞ fragmentParticlePerformance –≤ pipeline.

    –ú–∏–Ω—É—Å —ç—Ñ—Ñ–µ–∫—Ç—ã - –ø–ª—é—Å FPS!
*/

fragment float4 fragmentParticlePerformance(
    VertexOut in [[stage_in]],
    float2 pointCoord [[point_coord]],
    constant SimulationParams * params [[buffer(1)]]
) {
    // –ü—Ä–æ—Å—Ç–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
    float2 uv = pointCoord * 2.0 - 1.0;
    float dist = length(uv);

    // –ü—Ä–æ—Å—Ç–∞—è –∫—Ä—É–≥–ª–∞—è —Ñ–æ—Ä–º–∞
    float alpha = 1.0 - smoothstep(1.0 - PARTICLE_EDGE_SOFTNESS, 1.0, dist);
    if (alpha < PARTICLE_ALPHA_THRESHOLD) {
        discard_fragment();
    }

    // –ú–ò–ù–ò–ú–ê–õ–¨–ù–û–ï –û–°–í–ï–©–ï–ù–ò–ï
    float3 col;

    if (params[0].state == SIMULATION_STATE_LIGHTNING_STORM) {
        // –£–ø—Ä–æ—â–µ–Ω–Ω—ã–µ —Ü–≤–µ—Ç–∞ –±—É—Ä–∏
        float electricSeed = dot(uv, float2(12.9898, 78.233)) + params[0].time;
        float hue = hash(electricSeed) * TWO_PI;
        col = float3(
            0.3 + 0.7 * sin(hue),
            0.4 + 0.6 * cos(hue),
            0.8
        ) * 3.0;
    } else {
        // –¢–æ–ª—å–∫–æ –ø—Ä–æ—Å—Ç–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ
        float glow = pow(1.0 - dist, 2.5) * GLOW_BASE_INTENSITY;
        col = clamp(in.color.rgb * in.brightnessBoost, 0.0, 1.0) + glow;
    }

    float finalAlpha = alpha * in.color.a;
    return float4(col, finalAlpha);
}

#endif /* Basic_h */
