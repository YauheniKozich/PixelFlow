# ImageParticleGenerator

Модульная система генерации частиц из изображений с высокой производительностью и гибкой конфигурацией.

## Архитектура

### Структура папок

```
ImageParticleGenerator/
├── Core/              # Ядро системы
│   ├── ImageParticleGenerator.swift    # Главный координатор
│   ├── GeneratorProtocol.swift         # Базовые протоколы
│   ├── Protocols.swift                 # Общие протоколы
│   └── Core-README.md                  # Документация ядра
├── Analysis/          # Анализ изображений
│   ├── ImageAnalyzer.swift            # Анализатор изображений
│   ├── ImageAnalysis.swift            # Структуры данных анализа
│   └── Analysis-README.md             # Документация анализа
├── Sampling/          #  Сэмплинг пикселей
│   ├── PixelSampler.swift             # Сэмплер пикселей
│   ├── PixelSampling.swift            # Утилиты сэмплинга
│   └── Sampling-README.md             # Документация сэмплинга
├── Assembly/          #  Сборка частиц
│   ├── ParticleAssembler.swift        # Сборщик частиц
│   └── Assembly-README.md             # Документация сборки
├── Configuration/     #  Конфигурация
│   ├── Configuration.swift            # Конфигурационные структуры
│   └── Configuration-README.md        # Документация конфигурации
└── Caching/           #  Кэширование
    ├── CacheManager.swift             # Менеджер кэша
    └── Caching-README.md              # Документация кэширования
```

### Основные компоненты

#### Core (Ядро)

**ImageParticleGenerator** - главный координатор системы:
- Управляет жизненным циклом генерации частиц
- Координирует работу всех компонентов
- Предоставляет публичный API
- Обрабатывает асинхронные операции

**Протоколы:**
- `ImageParticleGeneratorProtocol` - основной интерфейс генератора
- `ParticleGeneratorDelegate` - обратные вызовы для отслеживания прогресса

#### Analysis (Анализ)

**ImageAnalyzer** - интеллектуальный анализ изображений:
- Вычисляет средний цвет, контрастность, яркость
- Определяет сложность изображения
- Находит доминирующие цвета
- SIMD-оптимизированные вычисления

**ImageAnalysis** - структуры данных с результатами анализа

####  Sampling (Сэмплинг)

**PixelSampler** - умный отбор пикселей:
- **Uniform**: равномерное распределение по изображению
- **Importance**: выбор по важности (контраст, насыщенность)
- **Adaptive**: адаптивная плотность в сложных областях
- **Hybrid**: комбинированные стратегии

####  Assembly (Сборка)

**ParticleAssembler** - преобразование сэмплов в частицы:
- Масштабирование под размер экрана
- Назначение цветов, размеров, позиций
- Настройка свойств частиц

#### Configuration (Конфигурация)

**ParticleGenerationConfig** - гибкие настройки:
- Стратегии сэмплинга и качества
- Параметры производительности
- Настройки кэширования

#### Caching (Кэширование)

**CacheManager** - умное кэширование результатов:
- Автоматическая очистка по LRU
- Хэширование ключей
- Потокобезопасность

## Как работает система

### 1. Инициализация

```swift
let generator = try ImageParticleGenerator(image: image, particleCount: 1000)
generator.updateScreenSize(CGSize(width: 1920, height: 1080))
```

### 2. Этап анализа

```
ImageAnalyzer анализирует изображение:
├── Вычисляет базовые метрики (яркость, контраст)
├── Определяет цветовую палитру
├── Оценивает сложность и текстуру
└── SIMD-оптимизированные вычисления
```

### 3. Этап сэмплинга

```
PixelSampler выбирает пиксели:
├── Применяет выбранную стратегию (uniform/importance/adaptive/hybrid)
├── Извлекает реальные цвета пикселей
├── Оптимизирует выбор по важности
└── Создает массив Sample (x, y, color)
```

### 4. Этап сборки

```
ParticleAssembler создает частицы:
├── Преобразует координаты в экранное пространство
├── Назначает цвета из сэмплов
├── Настраивает размеры и свойства
└── Возвращает массив Particle
```

### 5. Кэширование

```
CacheManager сохраняет результаты:
├── Хэширует ключ на основе параметров
├── Сериализует массив частиц
├── Управляет размером кэша
└── Предоставляет быстрый доступ
```

## Ключевые особенности

### Производительность
- **SIMD оптимизации** с Accelerate фреймворком
- **Многопоточная обработка** анализа изображений
- **Эффективное кэширование** результатов
- **Оптимизированные алгоритмы** сэмплинга

### Интеллектуальность
- **Умный анализ** изображений с множеством метрик
- **Адаптивные стратегии** выбора пикселей
- **Взвешенный сэмплинг** по важности
- **Качественные пресеты** (draft/standard/high/ultra)

### Гибкость
- **Модульная архитектура** с заменяемыми компонентами
- **Протокольно-ориентированный дизайн**
- **Расширяемая конфигурация**
- **Поддержка разных стратегий**

### Надежность
- **Комплексная валидация** входных данных
- **Обработка ошибок** с понятными сообщениями
- **Потокобезопасность** операций
- **Отслеживание прогресса** генерации

## Стратегии сэмплинга

### Uniform (Равномерный)
- Равномерное распределение точек по изображению
- Быстрый, предсказуемый результат
- Подходит для простых изображений

### Importance (По важности)
- Выбор пикселей с высоким контрастом и насыщенностью
- Учитывает локальные особенности изображения
- Создает более естественное распределение

### Adaptive (Адаптивный)
- Повышенная плотность в областях с высокой детализацией
- Автоматическая адаптация к сложности изображения
- Лучше сохраняет мелкие детали

### Hybrid (Гибридный)
- Комбинация нескольких стратегий
- Баланс между скоростью и качеством
- Рекомендуется для большинства случаев

## Использование

### Базовое использование

```swift
// Создание генератора
let generator = try ImageParticleGenerator(image: myImage, particleCount: 1000)

// Настройка экрана
generator.updateScreenSize(CGSize(width: 1920, height: 1080))

// Генерация частиц
let particles = try generator.generateParticles()
```

### С кастомной конфигурацией

```swift
var config = ParticleGenerationConfig.default
config.samplingStrategy = .importance
config.qualityPreset = .high
config.enableCaching = true

let generator = try ImageParticleGenerator(image: myImage, particleCount: 1000, config: config)
```

### Асинхронная генерация

```swift
generator.generateParticlesAsync { result in
    switch result {
    case .success(let particles):
        // Обработка частиц
        break
    case .failure(let error):
        // Обработка ошибки
        break
    }
}
```

## Тестирование

Система включает комплексные тесты, расположенные в отдельной папке `ImageParticleGenerator-Tests/` (вне основного проекта):

- `working_test.swift` - основной функциональный тест
- `comprehensive_test.swift` - полный набор тестов всех функций
- `integration_test.swift` - проверка интеграции с проектом

**Запуск тестов:**
```bash
cd ImageParticleGenerator-Tests
swift working_test.swift
swift comprehensive_test.swift
swift integration_test.swift
```

## Примечание о структуре

Для избежания конфликтов при сборке Xcode, README файлы в подпапках имеют префиксы с названиями папок:

- `Core-README.md` - документация ядра
- `Analysis-README.md` - документация анализа
- `Sampling-README.md` - документация сэмплинга
- `Assembly-README.md` - документация сборки
- `Configuration-README.md` - документация конфигурации
- `Caching-README.md` - документация кэширования

Это предотвращает ошибку "Multiple commands produce" при сборке проекта.

## Производительность

### Оптимизации
- **SIMD**: Векторизованные вычисления в анализе изображений
- **Concurrency**: Параллельная обработка независимых задач
- **Caching**: Избегание повторных вычислений
- **Memory**: Эффективное управление памятью

### Метрики
- Анализ 1000x1000 изображения: ~50мс
- Генерация 10000 частиц: ~200мс
- Кэширование: ускорение в 10-100 раз для повторных вызовов

## Жизненный цикл

1. **Создание** - инициализация компонентов
2. **Анализ** - глубокий анализ изображения
3. **Сэмплинг** - выбор важных пикселей
4. **Сборка** - создание частиц
5. **Кэширование** - сохранение результатов
6. **Возврат** - предоставление частиц пользователю

## Применение в PixelFlow

ImageParticleGenerator интегрирован в ParticleSystem и используется для:

- Генерации частиц из изображений пользователей
- Создания эффектов на основе фотографий
- Реалистичной симуляции частиц
- Визуализации данных в виде частиц

Система обеспечивает высокую производительность и качество визуализации в реальном времени.
